<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>csvprobe-web + ETL (SQLite)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:24px; line-height:1.4}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .card{border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #eee; padding:8px; text-align:left}
    select, input[type=text], input[type=url]{padding:8px;border:1px solid #ccc;border-radius:8px}
    button{padding:8px 12px; border:0; border-radius:8px; background:#2d6cdf; color:#fff; cursor:pointer}
    button.secondary{background:#666}
    code.block{display:block; white-space:pre-wrap; background:#fafafa; border:1px solid #eee; padding:12px; border-radius:8px}
    .pill{display:inline-block; padding:2px 8px; background:#eee; border-radius:12px; margin-left:6px; font-size:12px}
    #search{float:right}
    .muted{color:#666}

    /* Collapsible sections */
    .card.collapsible > h3{
      display:flex; align-items:center; justify-content:space-between; margin-top:0; cursor:pointer; user-select:none;
    }
    .card .section-body{margin-top:12px}
    .card.collapsed .section-body{display:none}
    .caret{
      display:inline-block; transition:transform .15s ease; margin-left:12px; font-size:14px
    }
    .card.collapsed .caret{transform:rotate(-90deg)}
    .toggle-help{font-size:12px; color:#888; margin-left:8px}
  </style>
</head>
<body>
  <h1>CSV Probe → Review → ETL → Browse</h1>

  <div class="card">
    <div class="row">
      <label>CSV URL <input id="url" type="url" size="60" placeholder="https://example.com/data.csv"></label>
      <label>Delimiter <input id="delim" type="text" size="2" value="," maxlength="1"></label>
      <label>Name (table) <input id="name" type="text" value="data_set_name"></label>
      <button id="btnProbe">Probe</button>
      <input id="search" type="text" placeholder="Search…"/>
    </div>
    <div id="probeStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <div id="config" class="card collapsible" style="display:none">
    <h3 aria-expanded="true">
      Detected fields (edit types & required). Choose Primary Key.
      <span class="toggle-help">click to collapse/expand</span>
      <span class="caret">▼</span>
    </h3>
    <div class="section-body">
      <div id="fields"></div>
      <div style="margin-top:12px" class="row">
        <button id="btnETL">Run ETL</button>
        <button id="btnDDL" class="secondary">View table schema</button>
        <span id="etlStatus" class="muted"></span>
      </div>
    </div>
  </div>

  <div id="ddlCard" class="card collapsible" style="display:none">
    <h3 aria-expanded="true">
      Table DDL
      <span class="toggle-help">click to collapse/expand</span>
      <span class="caret">▼</span>
    </h3>
    <div class="section-body">
      <code class="block" id="ddl"></code>
    </div>
  </div>

  <div id="samples" class="card collapsible" style="display:none">
    <h3 aria-expanded="true">
      Field samples
      <span class="toggle-help">click to collapse/expand</span>
      <span class="caret">▼</span>
    </h3>
    <div class="section-body">
      <div id="sampleRows"></div>
    </div>
  </div>

  <div id="results" class="card collapsible" style="display:none">
    <h3 aria-expanded="true">
      Search results
      <span class="toggle-help">click to collapse/expand</span>
      <span class="caret">▼</span>
    </h3>
    <div class="section-body">
      <div id="grid"></div>
    </div>
  </div>

<script>
let currentConfig = null;
const typeOptions = ["text","integer","real","date","datetime","bool"];

function $(id){ return document.getElementById(id); }
function escapeHtml(s){ return s===null||s===undefined ? "" : String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

/* Collapsible helpers */
function initCollapsible(card){
  if(!card) return;
  const header = card.querySelector('h3');
  const body = card.querySelector('.section-body');

  if(!body){
    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'section-body';
    while(header.nextSibling){
      bodyDiv.appendChild(header.nextSibling);
    }
    card.appendChild(bodyDiv);
  }

  header.addEventListener('click', (e)=>{
    const tag = e.target.tagName;
    if(tag === 'BUTTON' || tag === 'A' || tag === 'INPUT' || tag === 'SELECT' || tag === 'LABEL') return;
    card.classList.toggle('collapsed');
    header.setAttribute('aria-expanded', String(!card.classList.contains('collapsed')));
  });
}

function initAllCollapsibles(){
  document.querySelectorAll('.card.collapsible').forEach(initCollapsible);
}

/* Workflow functions */
async function probe(){
  $("probeStatus").textContent = "Probing…";
  const body = {
    url: $("url").value,
    delimiter: $("delim").value || ",",
    name: $("name").value || "data",
    bytes: 20000,
    datepref: "auto"
  };
  const res = await fetch("/api/probe",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(!res.ok){ $("probeStatus").textContent = "Probe error: "+await res.text(); return; }
  const data = await res.json();
  currentConfig = data.config;
  renderConfig();
  $("probeStatus").textContent = "Probe OK. Review fields & run ETL.";
}

function renderConfig(){
  const c = currentConfig;
  $("config").style.display = "";
  const wrap = $("fields");
  wrap.innerHTML = `
    <table>
      <thead><tr><th>Primary</th><th>Name</th><th>Type</th><th>Required</th><th>Actions</th></tr></thead>
      <tbody>
      ${c.fields.map((f,i)=>`
        <tr>
          <td><input type="radio" name="pk" ${c.primary_key===f.name ? "checked":""} onchange="setPK('${f.name}')"></td>
          <td>${escapeHtml(f.name)}</td>
          <td>
            <select onchange="setType(${i}, this.value)">
              ${typeOptions.map(t=>`<option value="${t}" ${f.type===t?'selected':''}>${t}</option>`).join('')}
            </select>
          </td>
          <td><input type="checkbox" ${f.required?'checked':''} onchange="setRequired(${i}, this.checked)"></td>
          <td><button class="secondary" onclick="sampleField('${f.name}')">Sample 10</button><span class="pill">${escapeHtml(f.type)}</span></td>
        </tr>
      `).join('')}
      </tbody>
    </table>
  `;
  window.setType = (i,v)=>{ currentConfig.fields[i].type = v; renderConfig(); }
  window.setRequired = (i,v)=>{ currentConfig.fields[i].required = v; }
  window.setPK = (name)=>{ currentConfig.primary_key = name; renderConfig(); }
}

async function runETL(){
  $("etlStatus").textContent = "Running ETL…";
  currentConfig.source = {
    url: $("url").value,
    delimiter: $("delim").value || ",",
    name: $("name").value || "data",
  };
  const res = await fetch("/api/etl",{method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(currentConfig)});
  if(!res.ok){ $("etlStatus").textContent = "ETL error: "+await res.text(); return; }
  $("etlStatus").textContent = "Done. Try View schema or Search.";
  $("results").style.display = "none";
  $("ddlCard").style.display = "none";
  $("samples").style.display = "none";
}

async function viewDDL(){
  const table = currentConfig?.source?.name || $("name").value;
  const res = await fetch("/api/schema?table="+encodeURIComponent(table));
  if(!res.ok){ $("ddl").textContent = await res.text(); $("ddlCard").style.display = ""; return; }
  const data = await res.json();
  $("ddl").textContent = data.ddl || "(no ddl found)";
  $("ddlCard").style.display = "";
}

async function sampleField(field){
  const table = currentConfig?.source?.name || $("name").value;
  const res = await fetch(`/api/sample?table=${encodeURIComponent(table)}&field=${encodeURIComponent(field)}&limit=10`);
  const out = $("sampleRows");
  $("samples").style.display = "";
  if(!res.ok){ out.innerHTML = "<div>"+escapeHtml(await res.text())+"</div>"; return; }
  const data = await res.json();
  out.innerHTML = `<h4>${escapeHtml(field)}</h4><ul>` + data.rows.map(v=>`<li>${escapeHtml(v)}</li>`).join("") + `</ul>`;
}

let searchTimer = null;
async function doSearchNow(q){
  const table = currentConfig?.source?.name || $("name").value;
  const res = await fetch(`/api/search?table=${encodeURIComponent(table)}&q=${encodeURIComponent(q)}`);
  const grid = $("grid");
  $("results").style.display = "";
  if(!res.ok){ grid.textContent = await res.text(); return; }
  const data = await res.json();
  if((data.rows||[]).length===0){ grid.textContent = "(no matches)"; return; }
  const cols = data.columns;
  grid.innerHTML = `
    <table>
      <thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead>
      <tbody>
        ${data.rows.map(r=>`<tr>${cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('')}</tr>`).join('')}
      </tbody>
    </table>
  `;
}

/* Event bindings */
$("btnProbe").addEventListener("click", probe);
$("btnETL").addEventListener("click", runETL);
$("btnDDL").addEventListener("click", viewDDL);
$("search").addEventListener("input", (e)=>{
  const q = e.target.value;
  if(searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>doSearchNow(q), 160);
});

/* Initialize collapsibles */
document.addEventListener('DOMContentLoaded', initAllCollapsibles);
</script>
</body>
</html>

