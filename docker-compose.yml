services:
  # ---------------- PostgreSQL ----------------
  postgres:
    image: postgres:15
    container_name: postgres
    profiles: ["postgres"]
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-P@ssw0rd123!}
#      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-testdb}
      TZ: ${TZ:-Europe/Prague}
      POSTGRES_LOGGING_COLLECTOR: "on"  # Enables log collection
      POSTGRES_LOG_STATEMENT: "all"  # Logs all SQL statements
      POSTGRES_LOG_ERROR_VERBOSITY: "verbose"  # More detailed error logs
      POSTGRES_LOG_DESTINATION: "stderr"  # Ensure logs are output to stderr
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data:z
      # Any .sql/.sql.gz/.sh in this dir runs ONCE on first init
      - ./postgres/init:/docker-entrypoint-initdb.d:ro,z
#      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro  # Custom config file

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ---------------- Microsoft SQL Server ----------------
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: mssql
    profiles: ["mssql"]
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${SA_PASSWORD}
      MSSQL_PID: ${MSSQL_PID:-Developer}
      MSSQL_AGENT_ENABLED: ${MSSQL_AGENT_ENABLED:-true}
      TZ: ${TZ:-Europe/Prague}
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql:z
    healthcheck:
      test: ["CMD-SHELL", "pgrep sqlservr >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  # One-shot initializer for MSSQL (runs after mssql is healthy)
  mssql-init:
    image: mcr.microsoft.com/mssql-tools:latest
    container_name: mssql-init
    profiles: ["mssql"]
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      SA_PASSWORD: ${SA_PASSWORD}
      MSSQL_HOST: mssql
      MSSQL_PORT: 1433
      MSSQL_DB: ${MSSQL_DB:-testdb}
      APP_LOGIN: ${APP_LOGIN:-user}
      APP_PASSWORD: ${APP_PASSWORD:-password}
    volumes:
      - ./mssql/init.sh:/init.sh:ro,z
    entrypoint: ["/bin/bash", "-lc", "/init.sh"]
    restart: "no"

  # ---------------- Go Unit Tests ----------------
  go-tests:
    image: golang:1.25-alpine
    container_name: go-tests
    profiles: ["test"]
    working_dir: /workspace
    volumes:
      - ./:/workspace:z
    environment:
      TZ: ${TZ:-Europe/Prague}
    # Run all tests (verbose + race + cover); adjust as you like
    command: ["/bin/sh", "-c", "
      cd etl && 
      go test ./... -v -coverprofile=coverage.out ./... &&
      echo '\n--- Per-function coverage ---' &&
      go tool cover -func=coverage.out
    "]

volumes:
  pgdata:
  mssql-data:

